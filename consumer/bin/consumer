#!/usr/bin/env node

const util = require('./../src/helpers/util');

// Temporary hack to silence warnings.
const silenceDeprecation = function (fn) {
  return function (msg) {
    if (msg.includes("Deprecation Notice")) {
      return;
    }

    return fn(msg);
  }
}
console.warn = silenceDeprecation(console.warn)
console.error = silenceDeprecation(console.error)

const run = async function(fn, sleep) {
  let shutdown = false;

  process.on('SIGINT', function() {
    util.log.info('Shutting down...');
    shutdown = true;
  });

  while (!shutdown) {
    await fn();

    util.log.info('Sleeping...');
    await util.sleep(sleep);
  }
};

const args = process.argv.slice(2);

switch (args[0]) {
  case 'listen': {
    return run(require("./../src/listener")(), 1000);
  }
  case 'fetch': {
    return run(require("./../src/fetcher")(args[1]), 1000);
  }
  case 'record': {
    return run(require("./../src/recorder")(), 500);
  }
}
